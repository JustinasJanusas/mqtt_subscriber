<!-- physical device -->
<%-
    local uci = require("luci.model.uci").cursor()
    local util = require "luci.util"
    data_array = self.data_array
    local i = 1

    local function generate_config(config, delimiter)
	write("{")
	for name, val in pairs(config) do
		if type(val) == "table" then
			write(name .. ":")
			generate_config(val, true)
		else
			if type(val) == "boolean" then
				val = val and "true" or "false"
			end
			write(name .. ":" .. "\"" ..val .."\",")
		end
	end
	if delimiter then write("},") else write("}") end
end
-%>

<script src="<%=resource%>/vanilla-dataTables.js"></script>
<h3 class="content-title note-after hoverable" onclick="toggleContent(this, 'admin.bluetooth.available.toggle')">
    <div class="toggle-arrow expanded"><img src="<%=media%>/img/icons/arrow-toggle.svg"></div>
    <span><%=self.title%>
        <div class="label-info"><%=self.description%></div>
    </span>
</h3>
<div id="admin.bluetooth.available.toggle" class="toggle-content">
    <div class="table-wrapper">
        <table id="table" cellspacing="0" class=" no-hover" style="border-collapse: collapse; width: 100%;">
        <thead>
            <tr>
                <th><%:Device Name%></th>
                <th><%:RSSI%></th>
                <th><%:MAC Address%></th>
                <th><%:Pair%></th>
            </tr>
        </thead>
            <tbody>

            <%      if data_array["devices"] and data_array["devices"][1] then
                        while data_array["devices"][i] do
                            name = data_array["devices"][i]["name"] or "Nameless device"
                            rssi = data_array["devices"][i]["rssi"] or "N/A"
                            address = data_array["devices"][i]["address"] or "N/A"
                            local paired = util.ubus("blesem", "stat", {address = address})
                            if paired == nil then 
                            %>

                                <tr onclick="checkCheckbox(event)" class="trRow" name="<%=address%>">
                                    <td class="cbi-section-table-row" style="text-transform: uppercase;">
                                        <div class="div-heading"><%:Device Name%></div>
                                        <%=name%>
                                    </td>

                                    <td class="input-cell">
                                        <div class="div-heading"><%:RSSI%></div>
                                        <%=rssi%>
                                    </td>

                                    <td class="input-cell">
                                        <div class="div-heading"><%:MAC Address%></div>
                                        <%=address%>
                                    </td>

                                    <td>
                                        <div class="div-heading"><%:Select%></div>
                                        <input id="<%=address%>" class="available-device" type="checkbox" value="<%=address%>|<%=name%>">
                                    </td>
                                </tr>


                                <%end
                                i = i +1
                            
                        end 
                    else %>
                            <tr>
                                <td style="text-align: left;">No devices found</td>
                            </tr>
                    <%end%>


            </tbody>
        </table>
    </div>
<script>
    var config = <%generate_config(self.table_config)%>;
    var table = new DataTable("#table", config);
    checkToggled(document.getElementById("admin.bluetooth.available.toggle"), "admin.bluetooth.available.toggle")
    function checkCheckbox(event){
        var state = event.target.getAttribute("type")=="checkbox"
        if(!state){
            var device = event.currentTarget.getAttribute("name")
            let checkboxState = document.getElementById(device).checked
            document.getElementById(device).checked = !checkboxState
        }
    }
</script>
